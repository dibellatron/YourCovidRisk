<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% include 'base_analytics.html' %}
  <link rel="stylesheet" href="{{ url_for('static', filename='fontawesome/css/all.min.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Global styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- Generic slider layouts (3/4/5 options) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='exposure-calculator.css') }}">
  <script src="/static/js/slider-labels.js"></script>
  <script src="/static/js/utils/riskColorScale.js"></script>
  <!-- Import calculation display module -->
  <script type="module">
    import { toggleCalculationDisplay, populateCalculationSteps } from '/static/js/calculations/calculationDisplay.js';

    // Set environment flag for JavaScript
    window.DEBUG = {{ 'true' if DEBUG else 'false' }};
    window.IS_DEVELOPMENT = {{ 'true' if is_development else 'false' }};

    // Enhance populateCalculationSteps with detailed debugging
    const originalPopulate = populateCalculationSteps;
    const enhancedPopulate = function(data) {
      {% if is_development %}
      console.log("Called populateCalculationSteps with data:", data);
      {% endif %}

      // Get the elements first to see if they exist
      const step1Elem = document.getElementById('step1Detail');
      const step2Elem = document.getElementById('step2Detail');
      const step3Elem = document.getElementById('step3Detail');
      const step4Elem = document.getElementById('step4Detail');

      console.log("DOM elements:", {
        step1: step1Elem,
        step2: step2Elem,
        step3: step3Elem,
        step4: step4Elem
      });

      // Call the original function
      originalPopulate(data);

      // Check if values were set
      if (step1Elem) console.log("step1Detail after population:", step1Elem.innerHTML);
      if (step2Elem) console.log("step2Detail after population:", step2Elem.innerHTML);
      if (step3Elem) console.log("step3Detail after population:", step3Elem.innerHTML);
      if (step4Elem) console.log("step4Detail after population:", step4Elem.innerHTML);
    };

    // Make functions globally available
    window.toggleCalculationDisplay = toggleCalculationDisplay;
    window.populateCalculationSteps = enhancedPopulate;
  </script>
  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
  <link rel="icon" href="{{ url_for('static', filename='favicon-32x32.png') }}" type="image/png">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <title>Covid Test Calculator</title>
  <style>
    /* Hide spinner arrows in input number fields for Chrome, Safari, Edge, Opera */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* Hide spinner arrows in Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* h1/h2 heading styles moved to global stylesheet */

    h4 {
      color: var(--primary);
    }

    /* button styles moved to global stylesheet */

    /* FAQ Section styles with modern design */
    #faq {
      margin-top: 40px;
      border-top: 1px solid rgba(0,0,0,0.1);
      padding-top: 30px;
    }

    #faq h2 {
      margin-bottom: 1.5rem;
      color: var(--primary);
    }

    .faq-item {
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .faq-question {
      width: 100%;
      text-align: left;
      background-color: white;
      border: 1px solid rgba(229, 231, 235, 0.8);
      font-size: 1.1rem;
      font-weight: 600;
      padding: 1.25rem;
      cursor: pointer;
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .faq-question:hover {
      background-color: rgba(79, 70, 229, 0.05);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .faq-answer {
      display: none;
      padding: 1.25rem;
      background-color: white;
      border-left: 4px solid var(--primary);
      border-radius: var(--border-radius);
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      line-height: 1.6;
      animation: fadeIn 0.5s ease-out;
    }

    /* fadeIn animation moved to global stylesheet */

    /* nav styles moved to global stylesheet */

    /* basic form element styles moved to global stylesheet; retain caret tweaks */
    select {
      /* Custom styling with caret */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: pointer;
      background-color: #f9fafc;
      border: 1px solid #cbd5e1;
      position: relative;
      padding-right: 40px;
    }

    /* select-wrapper caret styling moved to global stylesheet */

    /* More obvious styling for dropdowns */
    .dropdown-styled {
      background-color: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      padding: 12px 36px 12px 16px;
      position: relative;
      transition: all 0.2s ease;
      cursor: pointer;
      /* Custom styling without background image */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Custom positioned arrow for test type dropdown */
    .test-header .select-wrapper::after {
      content: "\25BC"; /* ▼ */
      font-size: 12px;
      color: var(--primary);
      position: absolute;
      right: 56px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }

    /* Adjust test type arrow position for mobile */
    @media only screen and (max-width: 820px) {
      .test-header .select-wrapper::after {
        right: 16px;
      }
    }

    /* Custom positioned arrow for test result dropdown */
    .test-result .select-wrapper::after {
      content: "\25BC"; /* ▼ */
      font-size: 12px;
      color: var(--primary);
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }

    /* Add default text for empty selects */
    select option:first-child {
      color: #94a3b8;
    }


    /* Add a subtle dropdown effect on hover */
    select:hover {
      border-color: var(--primary);
      background-color: #f0f7ff;
      box-shadow: 0 2px 5px rgba(79, 70, 229, 0.15);
    }

    /* More obvious hover for styled dropdowns */
    .dropdown-styled:hover {
      border-color: var(--primary);
      box-shadow: 0 1px 4px rgba(79, 70, 229, 0.2);
    }

    /* Selected options should be clearly visible */
    select:valid {
      color: #1e293b;
      font-weight: 500;
    }


    /* Add caret to dropdowns using wrapper */
    /* select-wrapper moved to global */

    /* select-wrapper caret moved to global */

    select:focus, input[type="number"]:focus, input[type="range"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
      transform: translateY(-1px);
    }


    .slider-value-label {
      display: inline-block;
      margin-left: 10px;
      color: var(--primary);
      font-weight: 600;
      font-size: 1.1em;
      white-space: nowrap;
    }

    label {
      font-weight: 500;
      display: inline-block;
      margin-bottom: 0.75rem;
      color: #334155;
    }

    /* Container styles with hover effects */
    .container {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 2.5rem;
      margin: 0 auto 2.5rem;
      max-width: 1000px;
      border: 1px solid rgba(229, 231, 235, 0.8);
      transition: all 0.3s ease;
    }

    .container:hover {
      box-shadow: var(--shadow-lg);
    }

    /* Make the test blocks visually appealing */
    .test-block {
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background-color: rgba(248, 250, 252, 0.5);
      transition: all 0.3s ease;
    }

    .test-block:hover {
      background-color: #f8fafc;
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Make the advanced fields more visually appealing */
    #advancedFields {
      background-color: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
    }

    #advancedFields:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Responsive styles for all devices */
    @media only screen and (max-width: 820px) {
      body {
        font-size: 16px;
      }

      nav {
        margin: 0 0 1rem 0;
        padding: 1rem;
      }

      .container {
        padding: 1.5rem;
        margin: 0 1rem 1.5rem 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      nav a {
        font-size: 16px;
        margin-right: 1rem;
      }

      button {
        font-size: 16px;
        padding: 8px 16px;
      }

      input[type="number"], select {
        width: 100%;
        box-sizing: border-box;
      }
    }

    /* Layout test-block header on desktop and tablet */
    @media only screen and (min-width: 769px) {
      .test-block {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
      }
      .test-header {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        flex: 1;
      }
      .test-header label {
        margin-bottom: 0;
      }
      .test-number {
        flex: none;
        width: 2rem;
        text-align: right;
        line-height: 1.5;
        margin-top: 0.875rem;
      }
      .test-result {
        flex: 1;
      }
      .test-result label {
        margin-bottom: 0;
      }
    }
    @media only screen and (max-width: 820px) {
      .test-header {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      /* Hide the number placeholder when there's only one test */
      .test-number:empty {
        display: none;
      }
      .test-result {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
      }
    }

    /* Animations for conditional fields */
    /* fadeInSlideDown & fadeOutSlideUp moved to global stylesheet */

    /* Risk container animation */
    #riskContainer {
      animation: fadeIn 0.5s ease-out;
    }

    /* Apply animations to test blocks when they appear */
    .test-block {
      animation: fadeInSlideDown 0.4s ease-out forwards;
      overflow: hidden;
      transition: all 0.3s ease-in-out;
      transform-origin: top center;
    }

    /* Removed card-specific styling */

  </style>
</head>
<body data-page-type="test-calculator">
  <nav>
    <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a>
    <a href="{{ url_for('faq') }}"><i class="fas fa-book"></i> FAQ</a>
    <a href="https://ko-fi.com/yourcovidrisk" target="_blank" rel="noopener"><i class="fas fa-heart"></i> Donate</a>
  </nav>

  <div class="container" style="max-width: 1200px;">
    <!-- Hero section matching exposure calculator style -->
    <h1 style="text-align: center; margin: 1rem 0 1.5rem; font-size: 2.4rem; font-weight: 700; color: #111827; letter-spacing: -0.03em;">
      <i class="fas fa-vial" style="color: var(--secondary); margin-right: 12px;"></i>
      Covid Test Calculator
    </h1>
    
    <div class="hero-section">
      <div class="hero-content">
        <p>Enter your test results and related information to estimate the probability you're infected with COVID‑19. See the <a href="{{ url_for('faq') }}#test-how-calculated" style="color: inherit; text-decoration: underline;">FAQ</a> for info about how the calculator works.</p>
      </div>
    </div>

    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem 1.5rem; margin: 1.5rem auto; max-width: 600px; text-align: center; font-size: 0.9rem; color: #64748b;">
      <a href="https://ko-fi.com/yourcovidrisk" target="_blank" rel="noopener" style="color: #4f46e5; text-decoration: none; font-weight: 500;">Donate to support this project →</a>
    </div>

    <style>
    .hero-section {
      background: linear-gradient(135deg, #f0fbff 0%, #e6f7fd 100%);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .hero-content {
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
    }

    .hero-content p {
      color: #4b5563;
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 0;
    }

    .hero-features {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 1.5rem;
    }

    .feature {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .feature i {
      font-size: 1.5rem;
      color: var(--secondary);
      margin-bottom: 0.5rem;
    }

    .feature span {
      font-size: 0.95rem;
      font-weight: 500;
      color: #374151;
    }

    @media (max-width: 820px) {
      .hero-features {
        flex-direction: column;
        gap: 1rem;
      }
      
      .feature {
        flex-direction: row;
        text-align: left;
        gap: 1rem;
      }
      
      .feature i {
        margin-bottom: 0;
      }
    }
    </style>
    
    {% if error_message %}
      <p id="errorMessage" style="color: #ef4444;">{{ error_message }}</p>
    {% else %}
      <p id="errorMessage" style="color: #ef4444;"></p>
    {% endif %}

  <form method="post" id="dashboardForm">
    <input type="hidden" name="advanced" id="advanced" value="{{ request.form.get('advanced', '') }}">
    <div style="margin-bottom:15px;">
    <label for="symptoms">Do you have Covid-like symptoms?</label>
    <div class="select-wrapper">
      <select name="symptoms" id="symptoms" required class="dropdown-styled">
        <option value="" {% if not symptoms %}selected{% endif %}></option>
        <option value="yes" {% if symptoms == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no" {% if symptoms == 'no' %}selected{% endif %}>No</option>
        <option value="I'm not sure" {% if symptoms == "I'm not sure" %}selected{% endif %}>I'm not sure</option>
      </select>
      <span class="validation-message">Please select an option</span>
    </div>
    </div>
    <!-- Optional state selection for symptomatic prior rate -->
    <div style="margin-bottom:15px;">
      <label for="state">Where do you live? <span style="font-weight: normal;">(optional)</span></label>
      <div class="select-wrapper">
        <select name="state" id="state" class="dropdown-styled">
          <option value="" {% if state == '' %}selected{% endif %}></option>
          {% for code, name in states %}
          <option value="{{ code }}" {% if state == code %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div id="cautiousnessSection" style="margin-bottom:15px; {% if symptoms == 'no' or symptoms == "I'm not sure" %}display: block;{% else %}display: none;{% endif %}">
    <label for="covid_cautious" style="display: flex; align-items: center;">
      <span style="flex: 1;">Compared to the average person, how much potential Covid exposure did you have recently? <button type="button" id="cautionInfoBtn" onclick="toggleCautionInfo()"
        style="border: none; background: none; cursor: pointer; padding: 0; display: inline-flex; align-items: center; margin-left: 5px;">
        <span>&#8505;</span>
      </button></span>
    </label>
    <div class="slider-container">
      <input type="range" class="slider" name="covid_cautious_level" id="covid_cautious_level" min="1" max="6" step="1" value="{{ covid_cautious_level|default('3') }}" oninput="updateCautionLevel(this.value)">

      <script>
        function updateCautionLevel(value) {
          const val = parseInt(value);
          let text;

          if (val === 1) text = 'Much more';
          else if (val === 2) text = 'Somewhat more';
          else if (val === 3) text = 'About average';
          else if (val === 4) text = 'Somewhat less';
          else if (val === 5) text = 'Much less';
          else if (val === 6) text = 'Almost none';

          // Update the hidden input value
          document.getElementById('covid_cautious').value = text;

          // Update thumb positioning by adding CSS class
          const slider = document.getElementById('covid_cautious_level');
          if (slider) {
            // Remove all existing covid-level classes
            slider.classList.remove('covid-level-1', 'covid-level-2', 'covid-level-3', 'covid-level-4', 'covid-level-5', 'covid-level-6');
            // Add the class for current value
            slider.classList.add(`covid-level-${val}`);
          }

          // Update the label indicators by adding active class to selected one
          const sliderContainer = document.getElementById('covid_cautious_level').closest('.slider-container');
          if (sliderContainer) {
            // Remove active class from all labels
            const labels = sliderContainer.querySelectorAll('.slider-labels span');
            labels.forEach(label => {
              label.classList.remove('active');
            });

            // Add active class to the selected label (val-1 because val is 1-5, but array is 0-4)
            if (labels[val-1]) {
              labels[val-1].classList.add('active');
            }
          }
        }
        
        // Function to handle symptoms change
        function handleSymptomsChange() {
          const symptomsSelect = document.getElementById('symptoms');
          const cautiousnessSection = document.getElementById('cautiousnessSection');
          const cautiousnessSlider = document.getElementById('covid_cautious_level');
          
          if (symptomsSelect && cautiousnessSection) {
            if (symptomsSelect.value === 'no' || symptomsSelect.value === "I'm not sure") {
              // Show cautiousness section for asymptomatic users and unsure users
              cautiousnessSection.style.display = 'block';
              // Add required attribute when shown
              if (cautiousnessSlider) {
                cautiousnessSlider.setAttribute('required', '');
              }
            } else {
              // Hide cautiousness section for symptomatic users or when nothing selected
              cautiousnessSection.style.display = 'none';
              // Remove required attribute when hidden
              if (cautiousnessSlider) {
                cautiousnessSlider.removeAttribute('required');
              }
            }
          }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
          updateCautionLevel(document.getElementById('covid_cautious_level').value);
          
          // Set up event listener for symptoms dropdown
          const symptomsSelect = document.getElementById('symptoms');
          if (symptomsSelect) {
            symptomsSelect.addEventListener('change', handleSymptomsChange);
            // Also run once on page load to set initial state
            handleSymptomsChange();
          }
        });
      </script>
      <div class="slider-ticks">
        <span class="tick" style="left: 0%"></span>
        <span class="tick" style="left: 20%"></span>
        <span class="tick" style="left: 40%"></span>
        <span class="tick" style="left: 60%"></span>
        <span class="tick" style="left: 80%"></span>
        <span class="tick" style="left: 100%"></span>
      </div>
      <div class="slider-labels six-options">
        <span class="{{ 'active' if covid_cautious_level|default('3')|int == 1 }}">Much<br>more</span>
        <span class="{{ 'active' if covid_cautious_level|default('3')|int == 2 }}">Somewhat<br>more</span>
        <span class="{{ 'active' if covid_cautious_level|default('3')|int == 3 }}">About<br>average</span>
        <span class="{{ 'active' if covid_cautious_level|default('3')|int == 4 }}">Somewhat<br>less</span>
        <span class="{{ 'active' if covid_cautious_level|default('3')|int == 5 }}">Much<br>less</span>
        <span class="{{ 'active' if covid_cautious_level|default('3')|int == 6 }}">Almost<br>none</span>
      </div>
    </div>
    <input type="hidden" name="covid_cautious" id="covid_cautious" value="{{ covid_cautious|default('About average') }}">
      <div id="cautionInfo" style="display: none; padding: 10px; color: #555; font-size: 18px;">
      <p style="margin: 0 0 10px 0; font-weight: 500;">The baseline estimate is your calculated risk assuming average exposure levels. Your selection adjusts this baseline as follows:</p>
      <ul style="margin: 0; padding-left: 2px; list-style-position: inside;">
        <li><strong>Much more:</strong> You had significantly more high-risk exposure than typical (e.g., large gatherings, travel, minimal precautions). Your risk is adjusted to <strong>5 times</strong> the baseline estimate.</li>
        <li><strong>Somewhat more:</strong> You had more social contact or fewer precautions than average (e.g., attended events, dined indoors frequently). Your risk is adjusted to <strong>2 times</strong> the baseline estimate.</li>
        <li><strong>About average:</strong> Your activities and precautions were typical for most people in your area. This <strong>baseline risk estimate is used directly</strong> without adjustment.</li>
        <li><strong>Somewhat less:</strong> You took more precautions than average but still engaged in most normal activities with some safety measures. Your risk is adjusted to <strong>50%</strong> of the baseline estimate.</li>
        <li><strong>Much less:</strong> You had significantly fewer high-risk activities than most people (e.g., avoided crowds, masked consistently, limited indoor activities). Your risk is adjusted to <strong>10%</strong> of the baseline estimate.</li>
        <li><strong>Almost none:</strong> You had minimal contact with others and took maximum precautions (e.g., stayed home, fit-tested N95 when out, avoided indoor spaces). Your risk is adjusted to <strong>1%</strong> of the baseline estimate.</li>
      </ul>
    </div>
    </div>
    <div id="tests_container">
      {% if tests|length > 0 %}
      {% for test in tests %}
        <!-- Multiple test functionality re-enabled with advanced Bayesian model -->
        <div class="test-block">
          <div class="test-header">
            <span class="test-number"></span>
            <label>Test Type:
              <div class="select-wrapper">
                <select name="test_type" required class="dropdown-styled">
                <option value="" {% if not test.test_type %}selected{% endif %}></option>
              <option value="BinaxNOW" {% if test.test_type == 'BinaxNOW' %}selected{% endif %}>BinaxNOW</option>
              <option value="CorDx (Covid & Flu)" {% if test.test_type == 'CorDx (Covid & Flu)' %}selected{% endif %}>CorDx (Covid & Flu)</option>
              <option value="Flowflex (Covid-only)" {% if test.test_type == 'Flowflex (Covid-only)' %}selected{% endif %}>Flowflex (Covid-only)</option>
              <option value="Flowflex Plus (Covid & Flu)" {% if test.test_type == 'Flowflex Plus (Covid & Flu)' %}selected{% endif %}>Flowflex Plus (Covid & Flu)</option>
              <option value="iHealth (Covid & Flu)" {% if test.test_type == 'iHealth (Covid & Flu)' %}selected{% endif %}>iHealth (Covid & Flu)</option>
              <option value="iHealth (Covid-only)" {% if test.test_type == 'iHealth (Covid-only)' %}selected{% endif %}>iHealth (Covid-only)</option>
              <option value="Lucira" {% if test.test_type == 'Lucira' %}selected{% endif %}>Lucira</option>
              <option value="Metrix" {% if test.test_type == 'Metrix' %}selected{% endif %}>Metrix</option>
              <option value="OSOM (Covid & Flu)" {% if test.test_type == 'OSOM (Covid & Flu)' %}selected{% endif %}>OSOM (Covid & Flu)</option>
              <option value="Other RAT (Rapid Antigen Test)" {% if test.test_type == 'Other RAT (Rapid Antigen Test)' %}selected{% endif %}>Other RAT (Rapid Antigen Test)</option>
              <option value="Pluslife" {% if test.test_type == 'Pluslife' %}selected{% endif %}>Pluslife</option>
              <option value="WELLLife (Covid & Flu)" {% if test.test_type == 'WELLLife (Covid & Flu)' %}selected{% endif %}>WELLLife (Covid & Flu)</option>
                </select>
              </div>
            </label>
          </div>
          <label class="test-result">Test Result:
            <div class="select-wrapper">
              <select name="test_result" required class="dropdown-styled">
                <option value="" {% if not test.test_result %}selected{% endif %}></option>
                <option value="positive" {% if test.test_result == 'positive' %}selected{% endif %}>Positive</option>
                <option value="negative" {% if test.test_result == 'negative' %}selected{% endif %}>Negative</option>
              </select>
            </div>
            <!-- Remove buttons re-enabled for multiple test support -->
            {% if tests|length > 1 %}
            <button type="button" class="remove-test-btn" onclick="removeTestBlock(this)" style="margin-left: 10px; padding: 5px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
            {% endif %}
          </label>
        </div>
        {% endfor %}
      {% else %}
        <div class="test-block">
          <div class="test-header">
            <span class="test-number"></span>
            <label>Test Type:
              <div class="select-wrapper">
                <select name="test_type" required>
                <option value=""></option>
                <option value="BinaxNOW">BinaxNOW</option>
                <option value="CorDx (Covid & Flu)">CorDx (Covid & Flu)</option>
                <option value="Flowflex (Covid-only)">Flowflex (Covid-only)</option>
                <option value="Flowflex Plus (Covid & Flu)">Flowflex Plus (Covid & Flu)</option>
                <option value="iHealth (Covid & Flu)">iHealth (Covid & Flu)</option>
                <option value="iHealth (Covid-only)">iHealth (Covid-only)</option>
                <option value="Lucira">Lucira</option>
                <option value="Metrix">Metrix</option>
                <option value="OSOM (Covid & Flu)">OSOM (Covid & Flu)</option>
                <option value="Other RAT (Rapid Antigen Test)">Other RAT (Rapid Antigen Test)</option>
                <option value="Pluslife">Pluslife</option>
                <option value="WELLLife (Covid & Flu)">WELLLife (Covid & Flu)</option>
                </select>
              </div>
            </label>
          </div>
          <label class="test-result">Test Result:
            <div class="select-wrapper">
              <select name="test_result" required>
                <option value=""></option>
                <option value="positive">Positive</option>
                <option value="negative">Negative</option>
              </select>
            </div>
            <!-- No remove button for the first test -->
          </label>
        </div>
      {% endif %}
    </div>
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 10px; margin-top: 10px;">
      <!-- Multiple test functionality re-enabled with advanced Bayesian model -->
      <button type="button" class="secondary-btn" onclick="addTestBlock()">Add another test</button>
      <button type="button" class="secondary-btn" onclick="toggleAdvancedFields()">Advanced</button>
      <button type="button" class="secondary-btn" onclick="clearDashboard()">Clear</button>
    </div>
    <!-- Multiple tests timing info note -->
    <div id="multipleTestsTimingNote" class="multiple-tests-timing-note" style="display: none;">
      <i class="fas fa-info-circle"></i>
      <strong>Multiple tests:</strong> Enter tests taken at around the same time (within a few hours). 
      <a href="{{ url_for('faq') }}#multiple-test-question">Learn more</a>
    </div>
    <div id="advancedFields" style="display: {% if request.form.get('advanced', '') == 'true' or (covid_prevalence|trim != '' or positivity_rate|trim != '') %}block{% else %}none{% endif %}; margin-top: 10px; margin-left: 30px;">
      <div style="margin-bottom: 10px;">
        <label for="covidPrevalence" style="display: inline-block; width: 320px; white-space: nowrap;">Local Covid Prevalence (%) <span style="font-size: 0.9em; color: #777;">(optional)</span></label>
        <input type="number" name="covidPrevalence" id="covidPrevalence" step="any" min="0" max="100" value="{{ covid_prevalence|default('') }}" style="width: 60px; margin-left: 45px;">
        <br>
        <!-- Example link removed -->
      </div>
      <div style="margin-bottom: 10px;">
        <label for="positivityRate" style="display: inline-block; width: 320px; white-space: nowrap;">Local Positivity Rate (%) <span style="font-size: 0.9em; color: #777;">(optional)</span></label>
        <input type="number" name="positivityRate" id="positivityRate" step="any" min="0" max="100" value="{{ positivity_rate|default('') }}" style="width: 60px; margin-left: 45px;">
        <br>
        <!-- Example link removed -->
      </div>
      <div style="margin-bottom: 10px;">
        <label for="priorProbability" style="display: inline-block; width: 320px; white-space: nowrap;">Prior Probability of Infection (%) <span style="font-size: 0.9em; color: #777;">(optional)</span></label>
        <input type="number" name="priorProbability" id="priorProbability" step="any" min="0" max="100" value="{{ prior_probability|default('') }}" style="width: 60px; margin-left: 45px;">
        <small style="color: #555; display: block; margin-top: 5px;">
          Enter your best estimate of how likely you were to have Covid <em>prior</em> to any testing. If you're asymptomatic, you can estimate
          this probability using the <a href="{{ url_for('exposure_calculator') }}">Covid Exposure Risk Calculator</a>.
          If provided, then your updated probability of infection will be determined solely by this prior probability and your test result(s).
        </small>
      </div>
    </div>
    <br>
    <button type="submit" name="action" value="Calculate" class="primary-btn" onclick="analytics.trackButtonClick('calculate_test_probability', 'submit')">Calculate Probability of Infection <i class="fas fa-calculator"></i></button>
    
    <!-- Rate limit and calculation error messages (displayed below the button) -->
    <div id="calculationErrorMessage" style="display: none; margin-top: 1rem;"></div>
  </form>
</div>

{% from 'macros/calculation_display.html' import calculation_display %}

<div class="container" id="riskContainer" style="display: {% if risk is not none %}block{% else %}none{% endif %};">
    {% if risk is not none %}
      <h2 id="riskMessage">The probability you are infected with Covid is: <span id="testRiskValue" style="color: #334155;">
        {{ risk | percent }}
      </span></h2>
      <script>
        // Apply the risk color after the page loads using our shared utility
        document.addEventListener('DOMContentLoaded', function() {
          const riskElement = document.getElementById('testRiskValue');
          if (riskElement) {
            riskElement.style.color = getRiskColor({{ risk }});
          }
        });
      </script>
      <div id="confidenceIntervalsDisplay" style="display: none;">
          {% if tests|length > 1 %}
          <!-- Multiple tests: Coming soon message -->
          <div class="confidence-interval-section">
            <p>
              <strong>Uncertainty analysis for multiple tests is coming soon!</strong>
              <br><br>
              Currently, uncertainty analysis is only available when entering a single test result.
            </p>
          </div>
          {% else %}
          <!-- Single test: Enhanced Uncertainty Analysis -->
          {% if monte_carlo_prevalence_risk is not none %}
          <div class="confidence-interval-section">
            <p>
              {% set ci_51 = (monte_carlo_prevalence_risk['0.51'][0], monte_carlo_prevalence_risk['0.51'][1]) | ci_format %}
              {% set ci_99 = (monte_carlo_prevalence_risk['0.99'][0], monte_carlo_prevalence_risk['0.99'][1]) | ci_format %}
              Because of uncertainties in test accuracy, Covid prevalence, and positivity rates, even this probability is uncertain.
              <br><br>
              However, it is <strong>probably</strong> between <span class="mc-bound">{{ ci_51[0] }}</span> and <span class="mc-bound">{{ ci_51[1] }}</span> (51% credible interval).
              <br><br>
              It is <strong>almost certainly</strong> between <span class="mc-bound">{{ ci_99[0] }}</span> and <span class="mc-bound">{{ ci_99[1] }}</span> (99% credible interval).
            </p>
          </div>
          {% endif %}
          {% endif %}

          <!-- Commented out methods for potential future use
          
          Method 1: Min-Max Range 
          {% if min_max_range is not none %}
          <div class="confidence-interval-section">
            <h4>Min-Max Range (Conservative Bounds):</h4>
            <p style="font-size: smaller;">
              <strong>Absolute bounds:</strong> Your risk is between 
              <span class="mc-bound">{{ "%.2f"|format(min_max_range[0] * 100) }}%</span> and 
              <span class="mc-bound">{{ "%.2f"|format(min_max_range[1] * 100) }}%</span>
              <br><em>This shows the extreme possible range using worst/best case test performance values.</em>
            </p>
          </div>
          {% endif %}

          Method 2: Original Monte Carlo (Uniform Sampling)
          {% if monte_carlo_risk is not none %}
          <div class="confidence-interval-section">
            <h4>Monte Carlo Intervals (Uniform Sampling):</h4>
            <p style="font-size: smaller;">
              <strong>50.1% CI:</strong> <span class="mc-bound mc-bound-50">{{ "%.2f"|format(monte_carlo_risk['0.501'][0] * 100) }}%</span> - <span class="mc-bound mc-bound-50">{{ "%.2f"|format(monte_carlo_risk['0.501'][1] * 100) }}%</span> <em>(probable range)</em><br>
              <strong>95% CI:</strong> <span class="mc-bound">{{ "%.2f"|format(monte_carlo_risk['0.95'][0] * 100) }}%</span> - <span class="mc-bound">{{ "%.2f"|format(monte_carlo_risk['0.95'][1] * 100) }}%</span><br>
              <strong>99% CI:</strong> <span class="mc-bound">{{ "%.2f"|format(monte_carlo_risk['0.99'][0] * 100) }}%</span> - <span class="mc-bound">{{ "%.2f"|format(monte_carlo_risk['0.99'][1] * 100) }}%</span><br>
              <strong>99.9% CI:</strong> <span class="mc-bound">{{ "%.2f"|format(monte_carlo_risk['0.999'][0] * 100) }}%</span> - <span class="mc-bound">{{ "%.2f"|format(monte_carlo_risk['0.999'][1] * 100) }}%</span>
              <br><em>Based on 10,000 simulations with uniform sampling between test performance bounds.</em>
            </p>
          </div>
          {% endif %}

          Method 3: Enhanced Monte Carlo (Beta Distributions)
          {% if monte_carlo_beta_risk is not none %}
          <div class="confidence-interval-section">
            <h4>Enhanced Monte Carlo Intervals (Beta Distributions):</h4>
            <p style="font-size: smaller;">
              <strong>50.1% CI:</strong> <span class="mc-bound mc-bound-50">{{ "%.2f"|format(monte_carlo_beta_risk['0.501'][0] * 100) }}%</span> - <span class="mc-bound mc-bound-50">{{ "%.2f"|format(monte_carlo_beta_risk['0.501'][1] * 100) }}%</span> <em>(probable range)</em><br>
              <strong>95% CI:</strong> <span class="mc-bound">{{ "%.2f"|format(monte_carlo_beta_risk['0.95'][0] * 100) }}%</span> - <span class="mc-bound">{{ "%.2f"|format(monte_carlo_beta_risk['0.95'][1] * 100) }}%</span><br>
              <strong>99% CI:</strong> <span class="mc-bound">{{ "%.2f"|format(monte_carlo_beta_risk['0.99'][0] * 100) }}%</span> - <span class="mc-bound">{{ "%.2f"|format(monte_carlo_beta_risk['0.99'][1] * 100) }}%</span><br>
              <strong>99.9% CI:</strong> <span class="mc-bound">{{ "%.2f"|format(monte_carlo_beta_risk['0.999'][0] * 100) }}%</span> - <span class="mc-bound">{{ "%.2f"|format(monte_carlo_beta_risk['0.999'][1] * 100) }}%</span>
              <br><em>Based on 10,000 simulations using Beta distributions from study data (k/n values).</em>
            </p>
          </div>
          {% endif %}
          
          -->

          <!-- Show loading state if calculations are in progress (single test only) -->
          {% if tests|length == 1 and monte_carlo_prevalence_risk is none and monte_carlo_full_risk is none %}
          <div class="confidence-interval-section">
            <p>
              <span id="uncertaintyLoading">Calculating uncertainty ranges...<i class="fas fa-spinner fa-spin"></i></span>
            </p>
          </div>
          {% endif %}

        </div>
      <button id="toggleAdvancedRange" type="button" onclick="toggleAdvancedRangeDisplay()"
              class="secondary-btn">How certain is this result?</button>

      <script>
        // Mark Monte Carlo bounds with correct colors on page load
        document.addEventListener('DOMContentLoaded', function() {
          const mcBounds = document.querySelectorAll('.mc-bound');
          mcBounds.forEach(bound => {
            // Extract percentage value
            const percentText = bound.textContent.trim();
            const percentValue = parseFloat(percentText) / 100;

            if (!isNaN(percentValue)) {
              bound.style.color = getRiskColor(percentValue);
            }
          });
        });
      </script>

      <style>
        .confidence-interval-section {
          background-color: #f8fafc;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 3px solid var(--primary);
        }

        .confidence-interval-section h4 {
          margin-top: 0;
          margin-bottom: 10px;
          color: var(--primary-dark);
          font-size: 1rem;
        }

        .confidence-interval-explainer {
          font-size: 0.9rem;
          color: #64748b;
          margin-bottom: 20px;
          padding: 0 15px;
        }

        .mc-bound {
          font-weight: 600;
        }

        .mc-bound-50 {
          color: #2563eb;
          font-weight: 700;
          background-color: rgba(37, 99, 235, 0.1);
          padding: 2px 4px;
          border-radius: 3px;
        }

        .mc-bound-99 {
          opacity: 0.85;
        }

        .mc-bound-999 {
          opacity: 0.7;
        }

        #confidenceIntervalsDisplay {
          margin-top: 15px;
          margin-bottom: 15px;
        }
      </style>
      {{ calculation_display() }}

      <!-- Initialize calculation details if available -->
      <div id="debug-calculation-details" style="display: none;">
        <pre>{% if calculation_details is defined and calculation_details %}{{ calculation_details|tojson(indent=2) }}{% else %}{}{% endif %}</pre>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          if (typeof populateCalculationSteps === 'function') {
            // Use the populateCalculationSteps function to populate the steps
            {% if calculation_details is defined and calculation_details %}
            const calculationDetails = {{ calculation_details|tojson }};
            console.log("Calculation details from template:", calculationDetails);

            // Call the function to populate the steps
            // This will handle the display logic and preserve Python as source of truth
            populateCalculationSteps(calculationDetails);
            {% else %}
            console.log("No calculation details available yet");
            {% endif %}
          } else {
            console.error("populateCalculationSteps function not available");
          }
        });
      </script>
    {% endif %}
</div>


<script src="{{ url_for('static', filename='test-calculator.js') }}"></script>
<script src="{{ url_for('static', filename='js/slider-init.js') }}"></script>

<style>
  /* Style for validation errors */
  .validation-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
  }

  /* Custom validation message for selects */
  .select-wrapper select.validation-error + .validation-message {
    display: block;
  }

  /* Custom validation message for inputs */
  .input-wrapper {
    position: relative;
    display: inline-block;
  }

  .input-wrapper input.validation-error + .validation-message {
    display: block;
  }

  /* Common styling for validation messages */
  .validation-message {
    display: none;
    position: absolute;
    top: 100%;
    left: 0px;
    margin-top: 5px;
    background-color: #ef4444;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 10;
    white-space: normal;
    max-width: 250px;
    line-height: 1.2;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: max-content;
  }

  /* Multiple tests timing note styling */
  .multiple-tests-timing-note {
    margin-top: 8px;
    padding: 8px 12px;
    background-color: #f0f7ff;
    border-left: 3px solid #3b82f6;
    border-radius: 4px;
    font-size: 0.9em;
    color: #1e40af;
    animation: fadeInSlideDown 0.3s ease-out;
  }

  .multiple-tests-timing-note i {
    margin-right: 6px;
    color: #3b82f6;
  }

  .multiple-tests-timing-note a {
    color: #1e40af;
    text-decoration: underline;
  }

  .multiple-tests-timing-note a:hover {
    text-decoration: none;
  }

  /* Make result action buttons consistent on phone-sized screens */
  @media (max-width: 768px) {
    #toggleAdvancedRange,
    #toggleCalculation {
      width: 100%;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
  }


  /* Modern styling for remove test button */
  .remove-test-btn {
    background-color: #fee2e2;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    margin-left: 10px;
    padding: 2px 8px;
    font-size: 18px;
    font-weight: bold;
    line-height: 1;
    color: #ef4444;
    transition: all 0.2s ease;
    vertical-align: middle;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .remove-test-btn:hover {
    background-color: #fecaca;
    color: #dc2626;
    transform: scale(1.08);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Tooltip for remove button */
  .remove-test-btn::after {
    content: "Delete test";
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background-color: rgba(51, 65, 85, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: normal;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 10;
  }

  .remove-test-btn:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    transition-delay: 0.5s; /* Delay the tooltip appearance by 0.5s */
  }
</style>

  <footer style="margin-top: 30px; padding: 20px;">
    <div style="margin: 0 auto; padding: 15px; background-color: #f8f9fa; border-radius: 8px; max-width: 900px; font-size: 14px; color: #475569; text-align: left;">
      <p style="margin: 0;"><strong>Disclaimer:</strong> This site provides mathematical calculations for educational purposes only. It is not intended as medical advice, diagnosis, or treatment.</p>
    </div>
  </footer>
</body>
</html>
